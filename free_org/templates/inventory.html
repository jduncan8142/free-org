{% extends "base.html" %}

{% block title %}{{ title }} - Manage Inventory{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Inventory Management</h1>
        <div>
          <button id="refresh-inventory-btn" class="btn btn-outline-secondary me-2">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <a href="/inventory/add" class="btn btn-primary">
            <i class="fas fa-plus-circle"></i> Add New Item
          </a>
        </div>
      </div>
      
      <!-- Filters -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Filters</h5>
          <div class="row g-3">
            <div class="col-md-4">
              <label for="stand-filter" class="form-label">Concession Stand</label>
              <select class="form-select" id="stand-filter">
                <option value="">All Stands</option>
                <!-- Will be populated via API -->
              </select>
            </div>
            <div class="col-md-4">
              <label for="type-filter" class="form-label">Item Type</label>
              <select class="form-select" id="type-filter">
                <option value="">All Types</option>
                <option value="food">Food</option>
                <option value="drink">Drink</option>
                <option value="supply">Supply</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="available-filter" class="form-label">Availability</label>
              <select class="form-select" id="available-filter">
                <option value="">All Items</option>
                <option value="available">Available Only</option>
                <option value="low">Low Stock</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Inventory Table -->
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover" id="inventory-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Stand</th>
                  <th>Quantity</th>
                  <th>Unit</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Will be populated via API -->
                <tr id="loading-row">
                  <td colspan="7" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading inventory items...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Empty State -->
          <div id="empty-state" class="d-none text-center py-5">
            <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
            <h4>No Inventory Items Found</h4>
            <p class="text-muted">Start by adding some inventory items</p>
            <a href="/inventory/add" class="btn btn-primary mt-2">
              <i class="fas fa-plus-circle"></i> Add New Item
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Inventory Item Modal -->
<div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editItemModalLabel">Edit Inventory Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-item-form">
          <input type="hidden" id="edit-item-id">
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="edit-name" class="form-label">Item Name</label>
              <input type="text" class="form-control" id="edit-name" required>
            </div>
            <div class="col-md-6">
              <label for="edit-stand" class="form-label">Concession Stand</label>
              <select class="form-select" id="edit-stand">
                <option value="">-- Not Assigned --</option>
                <!-- Will be populated via API -->
              </select>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="edit-description" class="form-label">Description</label>
            <textarea class="form-control" id="edit-description" rows="2"></textarea>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="edit-type" class="form-label">Item Type</label>
              <select class="form-select" id="edit-type" required>
                <option value="food">Food</option>
                <option value="drink">Drink</option>
                <option value="supply">Supply</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="edit-unit" class="form-label">Unit</label>
              <select class="form-select" id="edit-unit" required>
                <option value="each">Each</option>
                <option value="box">Box</option>
                <option value="case">Case</option>
                <option value="pound">Pound</option>
                <option value="ounce">Ounce</option>
                <option value="gallon">Gallon</option>
                <option value="liter">Liter</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="edit-unit-cost" class="form-label">Unit Cost ($)</label>
              <input type="number" class="form-control" id="edit-unit-cost" min="0" step="0.01" required>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="edit-quantity" class="form-label">Quantity</label>
              <input type="number" class="form-control" id="edit-quantity" min="0" required>
            </div>
            <div class="col-md-6">
              <label for="edit-minimum-threshold" class="form-label">Minimum Threshold</label>
              <input type="number" class="form-control" id="edit-minimum-threshold" min="0" required>
              <div class="form-text">Items will be marked as low stock when quantity falls below this threshold</div>
            </div>
          </div>
          
          <div class="alert alert-danger d-none" id="edit-error-message"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-edit-btn">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Global variable to store the refresh interval
  let autoRefreshInterval = null;
  
  document.addEventListener('DOMContentLoaded', function() {
    // Load stands for the filter dropdown
    loadStands();
    
    // Load inventory items
    loadInventoryItems();
    
    // Set up filter change handlers
    document.getElementById('stand-filter').addEventListener('change', loadInventoryItems);
    document.getElementById('type-filter').addEventListener('change', loadInventoryItems);
    document.getElementById('available-filter').addEventListener('change', loadInventoryItems);
    
    // Set up refresh button handler
    document.getElementById('refresh-inventory-btn').addEventListener('click', function() {
      // Add spinner to button
      this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...';
      this.disabled = true;
      
      // Refresh inventory
      loadInventoryItems(true).then(() => {
        // Reset button
        this.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        this.disabled = false;
      }).catch(() => {
        // Reset button on error too
        this.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        this.disabled = false;
      });
    });
    
    // Start auto-refresh interval (every 30 seconds)
    startAutoRefresh();
    
    // Set up edit modal save button
    document.getElementById('save-edit-btn').addEventListener('click', saveInventoryItemChanges);
  });
  
  function loadStands() {
    fetch('/api/stands/?_t=' + Date.now(), {
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      }
    })
    .then(response => response.json())
    .then(stands => {
      // Populate the stand filter dropdown
      const standFilter = document.getElementById('stand-filter');
      stands.forEach(stand => {
        const option = document.createElement('option');
        option.value = stand.id;
        option.textContent = stand.name;
        standFilter.appendChild(option);
      });
      
      // Also populate the edit modal stand dropdown
      const editStandSelect = document.getElementById('edit-stand');
      stands.forEach(stand => {
        const option = document.createElement('option');
        option.value = stand.id;
        option.textContent = stand.name;
        editStandSelect.appendChild(option);
      });
      
      console.log('Stands loaded successfully');
    })
    .catch(error => {
      console.error('Error loading stands:', error);
    });
  }
  
  function startAutoRefresh() {
    // Clear existing interval if it exists
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
    }
    
    // Set new interval - refresh every 30 seconds
    autoRefreshInterval = setInterval(() => {
      console.log('Auto-refreshing inventory...');
      loadInventoryItems(false); // silent refresh
    }, 30000); // 30 seconds
  }
  
  // Modified loadInventoryItems to support promise return and force refresh
  function loadInventoryItems(forceRefresh = false) {
    const standFilter = document.getElementById('stand-filter').value;
    const typeFilter = document.getElementById('type-filter').value;
    const availableFilter = document.getElementById('available-filter').value;
    
    // Build query string
    let queryParams = new URLSearchParams();
    if (standFilter) {
      queryParams.append('stand_id', standFilter);
    }
    if (typeFilter) {
      queryParams.append('item_type', typeFilter);
    }
    if (availableFilter === 'available') {
      queryParams.append('available_only', 'true');
    }
    
    // Add cache-busting timestamp parameter 
    queryParams.append('_t', Date.now());
    
    // Show loading state
    document.getElementById('loading-row').classList.remove('d-none');
    document.getElementById('empty-state').classList.add('d-none');
    
    // Return a promise for the fetch operation
    return new Promise((resolve, reject) => {
      // Fetch inventory items with cache control
      fetch(`/api/inventory/?${queryParams.toString()}`, {
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      })
      .then(response => response.json())
      .then(items => {
        // Hide loading row
        document.getElementById('loading-row').classList.add('d-none');
        
        // Show empty state if no items
        if (items.length === 0) {
          document.getElementById('empty-state').classList.remove('d-none');
          resolve();
          return;
        }
        
        // Get stands for lookup
        return fetch('/api/stands/?_t=' + Date.now(), {
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        })
        .then(response => response.json())
        .then(stands => {
          // Create lookup map for stand names
          const standMap = new Map();
          stands.forEach(stand => {
            standMap.set(stand.id, stand.name);
          });
          
          console.log('Successfully refreshed inventory items');
          
          // Populate table
          const tableBody = document.getElementById('inventory-table').querySelector('tbody');
          tableBody.innerHTML = ''; // Clear existing rows
          
          items.forEach(item => {
            const row = document.createElement('tr');
            
            // Set background color for low stock
            if (item.quantity <= item.minimum_threshold) {
              row.classList.add('table-danger');
            }
            
            // Name column
            const nameCell = document.createElement('td');
            nameCell.textContent = item.name;
            if (item.description) {
              nameCell.setAttribute('data-bs-toggle', 'tooltip');
              nameCell.setAttribute('title', item.description);
            }
            row.appendChild(nameCell);
            
            // Type column
            const typeCell = document.createElement('td');
            typeCell.textContent = item.item_type.charAt(0).toUpperCase() + item.item_type.slice(1);
            row.appendChild(typeCell);
            
            // Stand column
            const standCell = document.createElement('td');
            standCell.textContent = item.stand_id ? standMap.get(item.stand_id) : 'â€”';
            row.appendChild(standCell);
            
            // Quantity column
            const quantityCell = document.createElement('td');
            quantityCell.textContent = item.quantity;
            row.appendChild(quantityCell);
            
            // Unit column
            const unitCell = document.createElement('td');
            unitCell.textContent = item.unit;
            row.appendChild(unitCell);
            
            // Status column
            const statusCell = document.createElement('td');
            if (item.quantity <= 0) {
              statusCell.innerHTML = '<span class="badge bg-danger">Out of Stock</span>';
            } else if (item.quantity <= item.minimum_threshold) {
              statusCell.innerHTML = '<span class="badge bg-warning text-dark">Low Stock</span>';
            } else {
              statusCell.innerHTML = '<span class="badge bg-success">In Stock</span>';
            }
            row.appendChild(statusCell);
            
            // Actions column
            const actionsCell = document.createElement('td');
            actionsCell.innerHTML = `
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-primary adjust-btn" data-item-id="${item.id}">
                  <i class="fas fa-plus-minus"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary edit-btn" data-item-id="${item.id}">
                  <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="btn btn-outline-danger delete-btn" data-item-id="${item.id}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            `;
            row.appendChild(actionsCell);
            
            tableBody.appendChild(row);
          });
          
          // Initialize tooltips
          var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
          });
          
          // Setup action buttons
          setupActionButtons();
          
          resolve();
        });
      })
      .catch(error => {
        console.error('Error loading inventory:', error);
        document.getElementById('loading-row').classList.add('d-none');
        
        // Show error message
        const tableBody = document.getElementById('inventory-table').querySelector('tbody');
        tableBody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-4 text-danger">
              <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
              <p>Error loading inventory items. Please try again.</p>
            </td>
          </tr>
        `;
        
        reject(error);
      });
    });
  }
  
  function setupActionButtons() {
    console.log('Setting up action buttons');
    
    // Adjust inventory quantity
    document.querySelectorAll('.adjust-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const itemId = this.getAttribute('data-item-id');
        // In a real implementation, show a modal to adjust quantity
        alert(`Adjust quantity for item ${itemId} - Not yet implemented`);
      });
    });
    
    // Edit inventory item
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const itemId = this.getAttribute('data-item-id');
        loadInventoryItemForEdit(itemId);
      });
    });
    
    // Delete inventory item
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const itemId = this.getAttribute('data-item-id');
        if (confirm('Are you sure you want to delete this inventory item?')) {
          // Disable button and show loading state
          const button = this;
          button.disabled = true;
          button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
          
          fetch(`/api/inventory/${itemId}?_t=${Date.now()}`, {
            method: 'DELETE',
            headers: {
              'Cache-Control': 'no-cache, no-store, must-revalidate',
              'Pragma': 'no-cache',
              'Expires': '0'
            }
          })
          .then(response => {
            if (response.ok) {
              // Reload inventory items with force refresh
              loadInventoryItems(true)
                .then(() => {
                  console.log('Inventory refreshed after delete');
                })
                .catch(error => {
                  console.error('Error refreshing inventory after delete:', error);
                });
            } else {
              alert('Error deleting inventory item');
              
              // Reset button
              button.disabled = false;
              button.innerHTML = '<i class="fas fa-trash"></i>';
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error deleting inventory item');
            
            // Reset button
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-trash"></i>';
          });
        }
      });
    });
  }
  
  function loadInventoryItemForEdit(itemId) {
    // Show loading state
    const saveButton = document.getElementById('save-edit-btn');
    saveButton.disabled = true;
    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
    
    // Hide previous error messages
    document.getElementById('edit-error-message').classList.add('d-none');
    
    // Fetch item details with cache prevention
    fetch(`/api/inventory/${itemId}?_t=${Date.now()}`, {
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to load item details');
      }
      return response.json();
    })
    .then(item => {
      console.log('Successfully loaded item details for editing');
      
      // Populate form fields
      document.getElementById('edit-item-id').value = item.id;
      document.getElementById('edit-name').value = item.name;
      document.getElementById('edit-description').value = item.description || '';
      document.getElementById('edit-type').value = item.item_type;
      document.getElementById('edit-unit').value = item.unit;
      document.getElementById('edit-quantity').value = item.quantity;
      document.getElementById('edit-minimum-threshold').value = item.minimum_threshold;
      document.getElementById('edit-unit-cost').value = item.unit_cost;
      document.getElementById('edit-stand').value = item.stand_id || '';
      
      // Show the modal
      const modal = new bootstrap.Modal(document.getElementById('editItemModal'));
      modal.show();
      
      // Re-enable save button
      saveButton.disabled = false;
      saveButton.textContent = 'Save Changes';
    })
    .catch(error => {
      console.error('Error loading item details:', error);
      alert('Error loading item details. Please try again.');
      
      // Re-enable save button
      saveButton.disabled = false;
      saveButton.textContent = 'Save Changes';
    });
  }
  
  function saveInventoryItemChanges() {
    // Get form values
    const itemId = document.getElementById('edit-item-id').value;
    const name = document.getElementById('edit-name').value.trim();
    const description = document.getElementById('edit-description').value.trim();
    const itemType = document.getElementById('edit-type').value;
    const unit = document.getElementById('edit-unit').value;
    const quantity = parseInt(document.getElementById('edit-quantity').value);
    const minimumThreshold = parseInt(document.getElementById('edit-minimum-threshold').value);
    const unitCost = parseFloat(document.getElementById('edit-unit-cost').value);
    const standId = document.getElementById('edit-stand').value || null;
    
    // Validate required fields
    if (!name) {
      showEditError('Item name is required');
      return;
    }
    
    // Prepare data for API
    const itemData = {
      name,
      description: description || null,
      item_type: itemType,
      unit,
      quantity,
      minimum_threshold: minimumThreshold,
      unit_cost: unitCost,
      stand_id: standId ? parseInt(standId) : null
    };
    
    // Show loading state
    const saveButton = document.getElementById('save-edit-btn');
    saveButton.disabled = true;
    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
    
    // Send update to API with cache prevention
    fetch(`/api/inventory/${itemId}?_t=${Date.now()}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      },
      body: JSON.stringify(itemData)
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.detail || 'Failed to update inventory item');
        });
      }
      return response.json();
    })
    .then(updatedItem => {
      console.log('Successfully updated inventory item');
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('editItemModal'));
      modal.hide();
      
      // Reload inventory items with force refresh
      loadInventoryItems(true)
        .then(() => {
          console.log('Inventory refreshed after update');
        })
        .catch(error => {
          console.error('Error refreshing inventory after update:', error);
        });
      
      // Re-enable save button
      saveButton.disabled = false;
      saveButton.textContent = 'Save Changes';
    })
    .catch(error => {
      console.error('Error updating item:', error);
      showEditError(error.message || 'Error updating inventory item. Please try again.');
      
      // Re-enable save button
      saveButton.disabled = false;
      saveButton.textContent = 'Save Changes';
    });
  }
  
  function showEditError(message) {
    const errorElement = document.getElementById('edit-error-message');
    errorElement.textContent = message;
    errorElement.classList.remove('d-none');
  }
</script>
{% endblock %}